# .github/workflows/main.yml

name: 매주 화요일 자동 매칭 실행

on:
  schedule:
    - cron: '0 18 * * 1' # KST 화요일 새벽 3시 (UTC 월요일 18시)
  workflow_dispatch:

jobs:
  run-matching-script:
    runs-on: ubuntu-latest
    
    steps:
      # 1단계: 코드 가져오기
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2단계: Python 3.11 설치
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3단계: (수정) Secrets에서 .json 파일 생성 (echo -> printf)
      - name: Create Google Service Account Key File
        # (수정) echo는 \n 같은 문자를 잘못 해석할 수 있으므로, printf로 안전하게 파일을 생성합니다.
        run: printf "%s" "${{ secrets.GOOGLE_AUTH_SECRET }}" > ${{ env.SERVICE_ACCOUNT_FILE }}
        env:
          SERVICE_ACCOUNT_FILE: msdproject-466902-dd36cca121a8.json
          
      # 4단계: (신규) JSON 파일 유효성 검사
      # gspread가 아닌, Python의 내장 json.tool로 파일이 유효한지 "먼저" 검사합니다.
      # 이 단계가 실패하면, 100% Secret이 잘못 복사되었거나 파일 생성(3단계)에 문제가 있는 것입니다.
      - name: DEBUG - Validate the created JSON file
        run: |
          echo "--- [디버깅 시작] 생성된 .json 파일이 유효한지 검사합니다. ---"
          python -m json.tool ${{ env.SERVICE_ACCOUNT_FILE }}
          echo "--- [디버깅 종료] 'No JSON object could be decoded' 오류가 났다면 Secret 값을 확인하세요. ---"
        env:
          SERVICE_ACCOUNT_FILE: msdproject-466902-dd36cca121a8.json

      # 5단계: Python 라이브러리 설치
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 6단계: 메인 Python 스크립트 실행
      # (만약 4단계가 성공했는데 6단계가 실패한다면, 그건 gspread의 다른 문제입니다)
      - name: Run main matching script
        run: python match_stores.py

# .github/workflows/main.yml

name: 매주 화요일 자동 매칭 실행

on:
  schedule:
    - cron: '0 18 * * 1' # KST 화요일 새벽 3시 (UTC 월요일 18시)
  workflow_dispatch:

jobs:
  run-matching-script:
    runs-on: ubuntu-latest
    
    steps:
      # 1단계: 코드 가져오기
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2단계: Python 3.11 설치
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3단계: Secrets에서 .json 파일 생성
      - name: Create Google Service Account Key File
        run: echo "${{ secrets.GOOGLE_AUTH_SECRET }}" > ${{ env.SERVICE_ACCOUNT_FILE }}
        env:
          SERVICE_ACCOUNT_FILE: msdproject-466902-dd36cca121a8.json
          
      # --- [신규] 디버깅 코드 ---
      # 3.5단계: 생성된 .json 파일의 앞부분 5줄을 출력하여 '깨짐 여부' 확인
      - name: DEBUG - Print first 5 lines of the created JSON file
        run: |
          echo "--- [디버깅 시작] 생성된 .json 파일의 상단 5줄을 출력합니다. ---"
          head -n 5 ${{ env.SERVICE_ACCOUNT_FILE }}
          echo "--- [디버깅 종료] 이 내용이 올바른 JSON 형태가 맞는지 확인하세요. ---"
        env:
          SERVICE_ACCOUNT_FILE: msdproject-466902-dd36cca121a8.json
      # --- 디버깅 코드 종료 ---

      # 4단계: Python 라이브러리 설치
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5단계: 메인 Python 스크립트 실행 (여기서 오류 발생 시 3.5단계 로그 확인)
      - name: Run main matching script
        run: python match_stores.py
